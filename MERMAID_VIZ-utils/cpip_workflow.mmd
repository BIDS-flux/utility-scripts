%%{ init: { 
    "theme": "base",
    "themeVariables": {

        "fontSize": "16px",
        "fontFamily": "Inter, 'Helvetica Neue', Arial, sans-serif"
    },
  "sequence": { 
    "showSequenceNumbers": true,
    "wrap": true,
    "width": 200,
    "boxMargin": 10,
    "boxTextMargin": 5,
    "useMaxWidth": true
  }
} }%%
sequenceDiagram
    autonumber
    
    actor Admin as ğŸ§™ Data Manager
    
    box rgba(242, 108, 108, 1) Raw Data Acquisition
        participant WebForms as ğŸ“‹ Web Forms
        participant Scanner as ğŸ¥ MRI Scanner
        participant Mercure as ğŸ”€ DICOM Router<br/>(Storescp)
    end
    
    box rgba(218, 130, 71, 1) Local DevOps - GitLab
        participant DCM as ğŸ”ğŸ§  DICOM Study
        participant BIDS as ğŸ§  BIDS Dataset
        participant BehBIDS as ğŸ“ Behavioral BIDS
        participant QC as ğŸ” MRIQC
        participant Deriv as ğŸ§® BIDS Derivatives
    end
    
    box rgba(100, 209, 100, 1) Federated DevOps
        participant FedBIDS as â˜ï¸ BIDS (Fed)
        participant FedBeh as â˜ï¸ Behavioral (Fed)
        participant FedDeriv as â˜ï¸ Derivatives (Fed)
    end

    Note over Scanner,Mercure: Initial Setup
    Scanner ->> Mercure: Send DICOM Files
    Mercure ->> DCM: Initialize Study
    Mercure ->> BIDS: Initialize Dataset
    BIDS ->> QC: Initialize MRIQC
    BIDS ->> Deriv: Initialize Derivatives
    WebForms ->> BehBIDS: Initialize Behavioral Data
    
    rect rgba(232, 239, 250, 0.85)
        Note over WebForms,FedDeriv: Session Processing Loop
        
        loop Every New MRI Session
            Note over Scanner,BIDS: Imaging Data Pipeline
            Mercure ->> DCM: Add Session as Submodule
            DCM ->> BIDS: Trigger HeuDiConv Conversion
            
            BIDS ->>+ BIDS: Create Pull Request

            Note over BIDS,QC: Automated QC Steps
            BIDS ->> BIDS: Run BIDS Validator
            BIDS ->> BIDS: Check Protocol Compliance
            BIDS ->> BIDS: Apply Defacing
            BIDS ->> QC: Trigger MRIQC
            QC ->> BIDS: Attach QC Reports to PR

            BIDS ->>- Admin: ğŸ“§ Notify for Review
            Admin ->> BIDS: âœ… Review + Fix + Merge
            
            rect rgba(205, 236, 214, 0.95)
                Note over BIDS,FedBIDS: Sync to Federation
                BIDS ->> FedBIDS: ğŸš€ Push (Git + S3)
            end
            
            Note over BIDS,Deriv: Preprocessing Pipeline
            loop For Each Preprocessing Pipeline
                BIDS ->>+ Deriv: Trigger Preprocessing
                Deriv ->> Deriv: Create PR with Reports
                Deriv ->>- Admin: ğŸ“§ Notify for Review
                Admin ->> Deriv: âœ… Review Reports + Merge
                rect rgba(205, 236, 214, 0.95)
                    Note over Deriv,FedDeriv: Federation Sync      
                    Deriv ->> FedDeriv: ğŸš€ Push (Git + S3)
                end
            end
        end
    end

    rect rgba(250, 241, 231, 0.85)
        Note over WebForms,FedBeh: Cyclical Behavioral Update
        loop Every Cycle
            Note over WebForms,BehBIDS: Behavioral Data Pipeline
            WebForms ->> BehBIDS: Auto-update on Changes
            BehBIDS ->>+ BehBIDS: BIDS-like Structure Validation
            BehBIDS ->>+ BehBIDS: Create Pull Request
            BehBIDS ->>- Admin: ğŸ“§ Notify for Review
            Admin ->> BehBIDS: âœ… Review + Fix + Merge

            rect rgba(205, 236, 214, 0.95)
                Note over BehBIDS,FedBeh: Sync to Federation
                BehBIDS ->> FedBeh: ğŸš€ Push (Git + S3)
            end
        end
    end